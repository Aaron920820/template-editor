$.fn.extend({
	l_zoom: function(c) {
		this.css("position", "absolute");
		var a = c || "free";
		$(this).attr("l_zoom_mode", a);
		var b = $('<div class="zoom_right border_all"></div>');
		var x = $('<div class="zoom_right border_all"></div><div class="zoom_bottom border_all"></div><div class="zoom_rb border_all"></div><div class="zoom_rotate border_all"><i class="sync mini icon"></i></div>');
		if(this[0].className == 'dragtext') {
			this.append(b);
		} else {
			this.append(x);
		}

		$(".zoom_right").mousedown(function(h) {
			var g = $(this);
			var h = event || window.event;
			h.stopPropagation();
			var f = parseInt(g.parent().css("width"));
			var d = {
				x: h.clientX,
				y: h.clientY
			};
			window.onmousemove = function(i) {
				var i = event || window.event;
				g.parent().css("width", f + i.clientX - d.x)
			};
			window.onmouseup = function(i) {
				var i = event || window.event;
				window.onmousemove = null
			}
		});
		$(".zoom_bottom").mousedown(function(h) {
			var f = $(this);
			var h = event || window.event;
			h.stopPropagation();
			var g = parseInt(f.parent().css("height"));
			var d = {
				x: h.clientX,
				y: h.clientY
			};
			window.onmousemove = function(i) {
				var i = event || window.event;
				f.parent().css("height", g + i.clientY - d.y)
			};
			window.onmouseup = function(i) {
				var i = event || window.event;
				window.onmousemove = null
			}
		});
		$(".zoom_bottom").mousedown(function(h) {
			var f = $(this);
			var h = event || window.event;
			h.stopPropagation();
			var g = parseInt(f.parent().css("height"));
			var d = {
				x: h.clientX,
				y: h.clientY
			};
			window.onmousemove = function(i) {
				var i = event || window.event;
				f.parent().css("height", g + i.clientY - d.y)
			};
			window.onmouseup = function(i) {
				var i = event || window.event;
				window.onmousemove = null
			}
		});
		$(".zoom_rotate").mousedown(function(h) {
			var f = $(this);
			//计算旋转中心点X轴
			var allX = document.getElementById('editorIndex').offsetLeft;
			var allY = document.getElementById('editorIndex').offsetTop;
			var boxX = document.getElementById('editorPage').offsetLeft;
			var boxY = document.getElementById('editorPage').offsetTop;
			var imgX = parseInt($(this).parent().css('left').replace("px", "")) + parseInt($(this).parent().css("width").replace("px", "")) / 2;
			var imgY = parseInt($(this).parent().css('top').replace("px", "")) + parseInt($(this).parent().css("height").replace("px", "")) / 2;
			var offsetX = allX + boxX + imgX;
			var offsetY = allY + boxY + imgY;
			console.log(offsetX, offsetY)
			h.stopPropagation();
			window.onmousemove = function(event) {
				//offsetX和offsetY是原点坐标
				//event.pageX和event.pageY是鼠标坐标
				var rotate = Math.atan2(event.pageX - offsetX, event.pageY - offsetY) / Math.PI * 180;
				
				f.parent().css("transform", "rotate(" + parseInt(-rotate) + "deg)")
			}
			window.onmouseup = function(i) {
				var i = event || window.event;
				window.onmousemove = null
			}
		});
		$(".zoom_rb").mousedown(function(i) {
			var g = $(this);
			var i = event || window.event;
			i.stopPropagation();
			var f = parseInt(g.parent().css("width"));
			var h = parseInt(g.parent().css("height"));
			var d = {
				x: i.clientX,
				y: i.clientY
			};
			window.onmousemove = function(l) {
				var l = event || window.event;
				if(g.parent().attr("l_zoom_mode") === "free") {
					g.parent().css({
						"width": f + l.clientX - d.x,
						"height": h + l.clientY - d.y
					});
					if(parseInt(g.parent().css("width")) <= 5) {
						g.parent().css("width", 5)
					}
					if(parseInt(g.parent().css("height")) <= 5) {
						g.parent().css("height", 5)
					}
				} else {
					var j = (f + l.clientX - d.x) / f,
						k = (h + l.clientY - d.y) / h;
					if(j >= k) {
						g.parent().css({
							"width": j * f,
							"height": j * h
						});
						if(parseInt(g.parent().css("height")) <= 5) {
							g.parent().css({
								"width": (j * f) / (j * h) * 5,
								"height": 5
							})
						}
						console.log(j, f, k, h)
					} else {
						g.parent().css({
							"width": k * f,
							"height": k * h
						});
						if(parseInt(g.parent().css("width")) <= 5) {
							g.parent().css({
								"width": 5,
								"height": (k * h) / (k * f) * 5
							})
						}
					}
				}
			};
			window.onmouseup = function(j) {
				var j = event || window.event;
				window.onmousemove = null
			}
		});
		return this
	}
});